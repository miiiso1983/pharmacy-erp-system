#!/bin/bash

# ๐ ุชุดุบูู ุฎุงุฏู ูุธุงู ุฅุฏุงุฑุฉ ุงูุตูุฏููุฉ - ุฅุตุฏุงุฑ ูุญุณู

echo "๐ ุจุฏุก ุชุดุบูู ุฎุงุฏู ูุธุงู ุฅุฏุงุฑุฉ ุงูุตูุฏููุฉ..."

# ุงูุชุญูู ูู ูุฌูุฏ Python
if ! command -v python3 &> /dev/null; then
    echo "โ ุฎุทุฃ: Python 3 ุบูุฑ ูุซุจุช"
    exit 1
fi

echo "โ Python 3 ูุชุงุญ"

# ุชุญุฏูุฏ ูุฌูุฏ ุงูุชุทุจูู
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_DIR="$SCRIPT_DIR/PharmacyApp"

echo "๐ ูุฌูุฏ ุงูุชุทุจูู: $APP_DIR"

# ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ ุงูุชุทุจูู
if [ ! -d "$APP_DIR" ]; then
    echo "โ ุฎุทุฃ: ูุฌูุฏ ุงูุชุทุจูู ุบูุฑ ููุฌูุฏ: $APP_DIR"
    exit 1
fi

# ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงูุชุทุจูู
cd "$APP_DIR"

# ุงูุชุญูู ูู ูุฌูุฏ ุงููููุงุช
if [ ! -f "index.html" ]; then
    echo "โ ุฎุทุฃ: ูููุงุช ุงูุชุทุจูู ุบูุฑ ููุฌูุฏุฉ ูู $APP_DIR"
    exit 1
fi

echo "โ ูููุงุช ุงูุชุทุจูู ููุฌูุฏุฉ"

# ุฅููุงู ุฃู ุฎุงุฏู ูุนูู ุนูู ุงูููุงูุฐ ุงููุทููุจุฉ
echo "๐ ุฅููุงู ุงูุฎูุงุฏู ุงูุณุงุจูุฉ..."
pkill -f "python3 -m http.server" 2>/dev/null || true
lsof -ti:8080 | xargs kill -9 2>/dev/null || true

# ุงูุชุธุงุฑ ูููู
sleep 2

# ุงูุญุตูู ุนูู ุนููุงู IP ุงููุญูู
LOCAL_IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}')

# ุชุดุบูู ุงูุฎุงุฏู ุนูู ุงููููุฐ 8080
echo "๐ ุชุดุบูู ุงูุฎุงุฏู ุนูู ุงููููุฐ 8080..."
echo "๐ ูู ุงููุฌูุฏ: $(pwd)"

# ุชุดุบูู ุงูุฎุงุฏู ูู ุงูุฎูููุฉ
python3 -m http.server 8080 --bind 0.0.0.0 &
SERVER_PID=$!

# ุงูุชุธุงุฑ ูููู ูุชุดุบูู ุงูุฎุงุฏู
sleep 3

# ุงูุชุญูู ูู ุฃู ุงูุฎุงุฏู ูุนูู
if curl -s http://localhost:8080 > /dev/null; then
    echo "โ ุงูุฎุงุฏู ูุนูู ุจูุฌุงุญ!"
else
    echo "โ ูุดู ูู ุชุดุบูู ุงูุฎุงุฏู"
    kill $SERVER_PID 2>/dev/null
    exit 1
fi

echo ""
echo "๐ ุชู ุชุดุบูู ุฎุงุฏู ูุธุงู ุฅุฏุงุฑุฉ ุงูุตูุฏููุฉ ุจูุฌุงุญ!"
echo ""
echo "๐ ูุนูููุงุช ุงููุตูู:"
echo "   ๐ ุงูุฑุงุจุท ุงููุญูู: http://localhost:8080"
if [ ! -z "$LOCAL_IP" ]; then
    echo "   ๐ ุงูุฑุงุจุท ุงูุดุจูู: http://$LOCAL_IP:8080"
fi
echo "   ๐ฑ ูููุญุงูู: http://127.0.0.1:8080"
echo ""
echo "๐ฑ ุงูุตูุญุงุช ุงููุชุงุญุฉ:"
echo "   ๐ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ: http://localhost:8080"
echo "   ๐งช ุตูุญุฉ ุงูุงุฎุชุจุงุฑ: http://localhost:8080/test.html"
echo "   ๐ ุชุณุฌูู ุงูุฏุฎูู: http://localhost:8080/login.html"
echo "   ๐ ููุญุฉ ุงูุชุญูู: http://localhost:8080/dashboard.html"
echo "   ๐ช ุฅุฏุงุฑุฉ ุงููุฎุงุฒู: http://localhost:8080/warehouses.html"
echo "   ๐ฐ ูุจูุนุงุช ุงููุฎุฒู: http://localhost:8080/warehouse-sales.html"
echo "   ๐ ุชูุงุฑูุฑ ุงููุฎุงุฒู: http://localhost:8080/warehouse-reports.html"
echo ""
echo "๐ ุจูุงูุงุช ุงูุฏุฎูู ุงูุชุฌุฑูุจูุฉ:"
echo "   ๐ง ุงูุจุฑูุฏ: admin@pharmacy-erp.com"
echo "   ๐ ูููุฉ ุงููุฑูุฑ: password123"
echo ""

# ูุชุญ ุงููุชุตูุญ ุชููุงุฆูุงู
if command -v open &> /dev/null; then
    echo "๐ ูุชุญ ุงููุชุตูุญ..."
    sleep 2
    open http://localhost:8080/test.html
fi

# ุฅุจูุงุก ุงูุณูุฑูุจุช ูุนูู
trap "echo ''; echo '๐ ุฅููุงู ุงูุฎุงุฏู...'; kill $SERVER_PID 2>/dev/null; echo 'โ ุชู ุฅููุงู ุงูุฎุงุฏู ุจูุฌุงุญ'; exit" INT

# ุงูุชุธุงุฑ ุฅุดุงุฑุฉ ุงูุฅููุงู
wait $SERVER_PID
